// \file

// This is a helper program to test if the dynamic app loading functionality
// of Tock works. This app has another application's (tock-dpl-hello) binary
// pre-programmed into it. When the device boots, the dynamic process loader
// writes the new app to flash and loads it as a new process.

#include <math.h>
#include <stdio.h>
#include <string.h>

#include <libtock/kernel/app_loader.h>
#include <libtock/tock.h>

uint8_t tock_welcomes_dpl_binary[8192] =
{0x02, 0x00, 0x54, 0x00, 0x00, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x36, 0x29,
  0x30, 0x6b, 0x01, 0x00, 0x0c, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x24, 0x12, 0x00, 0x00, 0x09, 0x00, 0x14, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x24, 0x12, 0x00, 0x00, 0x2c, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x03, 0x00, 0x0e, 0x00, 0x74, 0x6f, 0x63, 0x6b, 0x2d, 0x64, 0x70, 0x6c, 0x2d, 0x68,
  0x65, 0x6c, 0x6c, 0x6f, 0x00, 0x00, 0x08, 0x00, 0x04, 0x00, 0x02, 0x00, 0x00, 0x00,
  0xec, 0x03, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x18, 0x04,
  0x00, 0x00, 0x2c, 0x08, 0x00, 0x00, 0x94, 0x00, 0x00, 0x00, 0xc0, 0x08, 0x00, 0x00,
  0x64, 0x01, 0x00, 0x00, 0xac, 0x04, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x44, 0x6a,
  0x04, 0xf1, 0x07, 0x04, 0x0c, 0x44, 0x07, 0x25, 0x24, 0xea, 0x05, 0x04, 0x85, 0x69,
  0xc6, 0x69, 0x35, 0x44, 0x0d, 0x44, 0x06, 0x00, 0x0f, 0x00, 0x9d, 0x42, 0x00, 0xdc,
  0xa5, 0x46, 0x00, 0x20, 0x29, 0x00, 0x05, 0xdf, 0xa5, 0x46, 0x0a, 0x20, 0x21, 0x00,
  0x05, 0xdf, 0x0b, 0x20, 0x29, 0x00, 0x05, 0xdf, 0x70, 0x68, 0x38, 0x44, 0x81, 0x46,
  0x30, 0x00, 0x39, 0x00, 0x00, 0xf0, 0x31, 0xf8, 0x70, 0x47, 0x10, 0xb5, 0x08, 0x4b,
  0x59, 0xf8, 0x03, 0x40, 0x20, 0x46, 0x00, 0xf0, 0x7d, 0xf9, 0x06, 0x4b, 0x01, 0x46,
  0x59, 0xf8, 0x03, 0x20, 0x20, 0x46, 0x00, 0xf0, 0x0a, 0xf8, 0x00, 0xf0, 0xc2, 0xf8,
  0x00, 0x20, 0x10, 0xbd, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb2,
  0x18, 0x47, 0x38, 0xb5, 0x0a, 0x4b, 0x05, 0x46, 0x0c, 0x46, 0x59, 0xf8, 0x03, 0x00,
  0x11, 0x46, 0x00, 0xf0, 0x01, 0xf9, 0x48, 0xb9, 0x21, 0x46, 0x28, 0x46, 0x00, 0xf0,
  0x0d, 0xf9, 0x20, 0xb9, 0x20, 0x46, 0xbd, 0xe8, 0x38, 0x40, 0x00, 0xf0, 0x18, 0xb9,
  0x38, 0xbd, 0x00, 0xbf, 0x04, 0x00, 0x00, 0x00, 0x0d, 0x46, 0x08, 0xb5, 0x41, 0x68,
  0x03, 0x68, 0x04, 0x46, 0x29, 0x44, 0x18, 0x44, 0x00, 0x22, 0xa3, 0x68, 0xb2, 0xeb,
  0x93, 0x0f, 0x1a, 0xd3, 0xd4, 0xe9, 0x03, 0x10, 0x62, 0x69, 0x21, 0x44, 0x28, 0x44,
  0x00, 0xf0, 0x2b, 0xf9, 0xd4, 0xe9, 0x06, 0x02, 0x00, 0x21, 0x28, 0x44, 0x00, 0xf0,
  0x33, 0xf9, 0x21, 0x6a, 0x21, 0x44, 0x00, 0x22, 0x0e, 0x1d, 0x0b, 0x68, 0xb2, 0xeb,
  0x93, 0x0f, 0x11, 0xd3, 0x00, 0x21, 0x08, 0x46, 0xff, 0xf7, 0xab, 0xff, 0x00, 0xf0,
  0xff, 0xf8, 0x50, 0xf8, 0x22, 0x30, 0x00, 0x2b, 0xb6, 0xbf, 0x03, 0xf1, 0x00, 0x43,
  0x5b, 0x19, 0x1b, 0x19, 0x41, 0xf8, 0x22, 0x30, 0x01, 0x32, 0xd4, 0xe7, 0x56, 0xf8,
  0x22, 0x00, 0x2b, 0x58, 0x00, 0x2b, 0xb6, 0xbf, 0x03, 0xf1, 0x00, 0x43, 0x5b, 0x19,
  0x1b, 0x19, 0x2b, 0x50, 0x02, 0x32, 0xdd, 0xe7, 0x40, 0x42, 0x70, 0x47, 0xff, 0xff,
  0x84, 0xb0, 0x0d, 0xf1, 0x10, 0x0c, 0x0c, 0xe9, 0x0f, 0x00, 0x9d, 0xf8, 0x00, 0x30,
  0x80, 0x2b, 0x05, 0xd0, 0x3b, 0xb9, 0x9d, 0xf8, 0x04, 0x00, 0x04, 0xb0, 0xff, 0xf7,
  0xee, 0xbf, 0x00, 0x20, 0x04, 0xb0, 0x70, 0x47, 0x00, 0x48, 0xfb, 0xe7, 0x00, 0xfc,
  0xff, 0xff, 0x84, 0xb0, 0x0d, 0xf1, 0x10, 0x0c, 0x0c, 0xe9, 0x0f, 0x00, 0x9d, 0xf8,
  0x00, 0x30, 0x23, 0xb9, 0x9d, 0xf8, 0x0c, 0x00, 0x04, 0xb0, 0xff, 0xf7, 0xda, 0xbf,
  0x00, 0x20, 0x04, 0xb0, 0x70, 0x47, 0x84, 0xb0, 0x0d, 0xf1, 0x10, 0x0c, 0x0c, 0xe9,
  0x0f, 0x00, 0x9d, 0xf8, 0x00, 0x30, 0x23, 0xb9, 0x9d, 0xf8, 0x0c, 0x00, 0x04, 0xb0,
  0xff, 0xf7, 0xca, 0xbf, 0x00, 0x20, 0x04, 0xb0, 0x70, 0x47, 0x10, 0xb5, 0x11, 0x4b,
  0x11, 0x4a, 0x59, 0xf8, 0x03, 0x10, 0x59, 0xf8, 0x02, 0x20, 0x0b, 0x68, 0x12, 0x68,
  0x93, 0x42, 0x16, 0xd0, 0x0e, 0x4a, 0x59, 0xf8, 0x02, 0x40, 0x14, 0x22, 0x5a, 0x43,
  0x01, 0x33, 0xa0, 0x18, 0xa4, 0x58, 0x5a, 0x42, 0x02, 0xf0, 0x0f, 0x02, 0x03, 0xf0,
  0x0f, 0x03, 0x58, 0xbf, 0x53, 0x42, 0x0b, 0x60, 0xd0, 0xe9, 0x03, 0x23, 0xd0, 0xe9,
  0x01, 0x01, 0xa0, 0x47, 0x01, 0x20, 0x10, 0xbd, 0x00, 0x20, 0xfc, 0xe7, 0x08, 0x00,
  0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x08, 0xb5, 0xff, 0xf7,
  0xd3, 0xff, 0x01, 0x46, 0x08, 0xb9, 0x01, 0x20, 0x00, 0xdf, 0x08, 0xbd, 0x01, 0x46,
  0x00, 0x20, 0x06, 0xdf, 0x10, 0xb5, 0x04, 0x46, 0x08, 0x46, 0x11, 0x46, 0x1a, 0x46,
  0x02, 0x9b, 0x01, 0xdf, 0x82, 0x28, 0x07, 0xd1, 0x01, 0x23, 0xc4, 0xe9, 0x01, 0x12,
  0x23, 0x70, 0x00, 0x23, 0x23, 0x73, 0x20, 0x46, 0x10, 0xbd, 0x02, 0x28, 0x05, 0xd1,
  0x00, 0x20, 0xc4, 0xe9, 0x01, 0x23, 0x20, 0x70, 0x21, 0x73, 0xf5, 0xe7, 0x01, 0x20,
  0x00, 0xf0, 0x5d, 0xf8, 0x10, 0xb5, 0x04, 0x46, 0x08, 0x46, 0x11, 0x46, 0x1a, 0x46,
  0x02, 0x9b, 0x02, 0xdf, 0x20, 0x70, 0xc4, 0xe9, 0x01, 0x12, 0xe3, 0x60, 0x20, 0x46,
  0x10, 0xbd, 0x10, 0xb5, 0x04, 0x46, 0x08, 0x46, 0x11, 0x46, 0x1a, 0x46, 0x02, 0x9b,
  0x04, 0xdf, 0x82, 0x28, 0x07, 0xd1, 0x01, 0x23, 0xc4, 0xe9, 0x01, 0x12, 0x23, 0x70,
  0x00, 0x23, 0x23, 0x73, 0x20, 0x46, 0x10, 0xbd, 0x02, 0x28, 0x05, 0xd1, 0x00, 0x20,
  0xc4, 0xe9, 0x01, 0x23, 0x20, 0x70, 0x21, 0x73, 0xf5, 0xe7, 0x01, 0x20, 0x00, 0xf0,
  0x34, 0xf8, 0x10, 0xb5, 0x86, 0xb0, 0x01, 0x22, 0x02, 0xac, 0x03, 0x46, 0x00, 0x91,
  0x20, 0x46, 0x11, 0x46, 0xff, 0xf7, 0xb1, 0xff, 0x94, 0xe8, 0x0f, 0x00, 0xff, 0xf7,
  0x58, 0xff, 0x00, 0xb2, 0x06, 0xb0, 0x10, 0xbd, 0x10, 0xb5, 0x86, 0xb0, 0x01, 0x22,
  0x02, 0xac, 0x03, 0x46, 0x00, 0x91, 0x20, 0x46, 0x11, 0x46, 0xff, 0xf7, 0xc9, 0xff,
  0x94, 0xe8, 0x0f, 0x00, 0xff, 0xf7, 0x57, 0xff, 0x00, 0xb2, 0x06, 0xb0, 0x10, 0xbd,
  0x10, 0xb5, 0x86, 0xb0, 0x00, 0x22, 0x00, 0x92, 0x02, 0xac, 0x01, 0x22, 0x03, 0x46,
  0x11, 0x46, 0x20, 0x46, 0xff, 0xf7, 0xaa, 0xff, 0x94, 0xe8, 0x0f, 0x00, 0xff, 0xf7,
  0x1f, 0xff, 0x00, 0xb2, 0x06, 0xb0, 0x10, 0xbd, 0x08, 0xb5, 0x09, 0x4b, 0x59, 0xf8,
  0x03, 0x30, 0x04, 0x46, 0x13, 0xb1, 0x00, 0x21, 0xaf, 0xf3, 0x00, 0x80, 0x06, 0x4b,
  0x59, 0xf8, 0x03, 0x30, 0x18, 0x68, 0x83, 0x6a, 0x03, 0xb1, 0x98, 0x47, 0x20, 0x46,
  0x00, 0xf0, 0x23, 0xf8, 0x00, 0xbf, 0x1c, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00,
  0x0a, 0x44, 0x91, 0x42, 0x00, 0xf1, 0xff, 0x33, 0x00, 0xd1, 0x70, 0x47, 0x10, 0xb5,
  0x11, 0xf8, 0x01, 0x4b, 0x03, 0xf8, 0x01, 0x4f, 0x91, 0x42, 0xf9, 0xd1, 0x10, 0xbd,
  0x02, 0x44, 0x03, 0x46, 0x93, 0x42, 0x00, 0xd1, 0x70, 0x47, 0x03, 0xf8, 0x01, 0x1b,
  0xf9, 0xe7, 0x03, 0x46, 0x13, 0xf8, 0x01, 0x2b, 0x00, 0x2a, 0xfb, 0xd1, 0x18, 0x1a,
  0x01, 0x38, 0x70, 0x47, 0x08, 0xb5, 0xff, 0xf7, 0x4b, 0xff, 0xff, 0xff, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6b, 0x00, 0x00, 0x80,
  0x99, 0x00, 0x00, 0x80, 0xc0, 0x08, 0x00, 0x00, 0xc4, 0x08, 0x00, 0x00, 0xc8, 0x08,
  0x00, 0x00, 0x2c, 0x08, 0x00, 0x00, 0xbc, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x54, 0x6f,
  0x63, 0x6b, 0x20, 0x6e, 0x6f, 0x77, 0x20, 0x73, 0x75, 0x70, 0x70, 0x6f, 0x72, 0x74,
  0x73, 0x20, 0x64, 0x79, 0x6e, 0x61, 0x6d, 0x69, 0x63, 0x20, 0x61, 0x70, 0x70, 0x20,
  0x69, 0x6e, 0x73, 0x74, 0x61, 0x6c, 0x6c, 0x73, 0x21, 0x0d, 0x0a, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xac, 0x03, 0x00, 0x80, 0xcc, 0x03, 0x00, 0x80, 0x8c, 0x03,
  0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x58, 0x08,
  0x00, 0x00, 0x58, 0x08, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x5c, 0x08, 0x00, 0x00,
  0x02, 0x98, 0x00, 0x00, 0x60, 0x08, 0x00, 0x00, 0x02, 0xa0, 0x00, 0x00, 0x64, 0x08,
  0x00, 0x00, 0x02, 0x8c, 0x00, 0x00, 0xb8, 0x08, 0x00, 0x00, 0x02, 0x03, 0x00, 0x00,
  0xbc, 0x08, 0x00, 0x00, 0x02, 0x03, 0x00, 0x00, 0x80, 0x00, 0xd0, 0x1a, 0x00, 0x00, };


#define FLASH_BUFFER_SIZE 512
#define RETURNCODE_SUCCESS 0

static bool setup_done    = false;   // to check if setup is done
static bool write_done    = false;   // to check if writing to flash is done
static bool finalize_done = false;   // to check if the kernel is done finalizing the process binary
static bool load_done     = false;   // to check if the process was loaded successfully

/******************************************************************************************************
* Callback functions
*
* Callback to let us know when the capsule is done writing data to flash
******************************************************************************************************/

// static void nop_callback(int a __attribute__((unused)), int b __attribute__((unused)), int c __attribute__((unused)), void *d __attribute__((unused))) {}

static void app_setup_done_callback(__attribute__((unused)) int   length,
                                    __attribute__((unused)) int   arg1,
                                    __attribute__((unused)) int   arg2,
                                    __attribute__((unused)) void* ud) {
  setup_done = true;
}

static void app_write_done_callback(__attribute__((unused)) int   length,
                                    __attribute__((unused)) int   arg1,
                                    __attribute__((unused)) int   arg2,
                                    __attribute__((unused)) void* ud) {
  write_done = true;
}

static void app_finalize_done_callback(__attribute__((unused)) int   arg0,
                                       __attribute__((unused)) int   arg1,
                                       __attribute__((unused)) int   arg2,
                                       __attribute__((unused)) void* ud) {
  finalize_done = true;
}

static void app_load_done_callback(__attribute__((unused)) int   length,
                                   __attribute__((unused)) int   arg1,
                                   __attribute__((unused)) int   arg2,
                                   __attribute__((unused)) void* ud) {
  load_done = true;
}

static void run_app_loader(void) {

  // Flash and load tock_welcomes_dpl_binary
  double app_size = sizeof(tock_welcomes_dpl_binary);

  int ret = libtock_app_loader_command_setup(app_size); // asks the capsule to set up for app flash
  if (ret != RETURNCODE_SUCCESS) {
    printf("[Error] Setup Failed: %d.\n", ret);
    printf("[Log] Exiting Application.\n");
    tock_exit(ret); // we failed, so we exit the program.
  }

  // wait on setup done callback
  yield_for(&setup_done);
  setup_done = false;

  // wait until the padding app write is done before
  // you send your app, or it will fail during write
  printf("[Success] Setup successful. Attempting to write app to flash now.\n");
  // writes app data to flash
  int ret1 = write_app(app_size, tock_welcomes_dpl_binary);
  if (ret1 != RETURNCODE_SUCCESS) {
    printf("[Error] App flash write unsuccessful: %d.\n", ret1);
    printf("[Log] Exiting Application.\n");
    tock_exit(ret1); // we failed, so we exit the program.
  }

  printf("[Success] App flashed successfully. Attempting to create a process now.\n");
  int ret2 = libtock_app_loader_command_load();   // request to load app
  if (ret2 != RETURNCODE_SUCCESS) {
    printf("[Error] Process creation failed: %d.\n", ret2);
    printf("[Log] Exiting Application.\n");
    tock_exit(ret2);   // we failed, so we exit the program.
  }

  // wait on load done callback
  yield_for(&load_done);
  load_done = false;

  app_size = 0;  // reset app_size
}


/******************************************************************************************************
*
* Function to write the app into the flash
*
* Takes app size and the app binary as arguments
******************************************************************************************************/

int write_app(double size, uint8_t binary[]) {

  int ret;
  uint32_t write_count = 0;
  uint8_t write_buffer[FLASH_BUFFER_SIZE];
  uint32_t flash_offset = 0;

  write_count = ceil(size / FLASH_BUFFER_SIZE);

  ret = libtock_app_loader_write_buffer(write_buffer, FLASH_BUFFER_SIZE);   // set the write buffer
  if (ret != RETURNCODE_SUCCESS) {
    printf("[Error] Failed to set the write buffer: %d.\n", ret);
    return -1;
  }

  for (uint32_t offset = 0; offset < write_count; offset++) {
    memcpy(write_buffer, &binary[FLASH_BUFFER_SIZE * offset], FLASH_BUFFER_SIZE);     // copy binary to write buffer
    flash_offset = (offset * FLASH_BUFFER_SIZE);
    ret = libtock_app_loader_command_write(flash_offset, FLASH_BUFFER_SIZE);
    if (ret != 0) {
      printf("[Error] Failed writing data to flash at address: 0x%lx\n", flash_offset);
      printf("[Error] Error nature: %d\n", ret);
      return -1;
    }
    yield_for(&write_done);     // wait until write done callback
    write_done = false;
  }

  // Now that we are done writing the binary, we ask the kernel to finalize it.
  printf("Done writing app, finalizing.\n");
  int ret2 = libtock_app_loader_finalize();
  if (ret2 != 0) {
    printf("[Error] Failed to finalize new process binary.\n");
    return -1;
  }
  yield_for(&finalize_done);
  finalize_done = false;

  return 0;
}


/******************************************************************************************************
*
* Main
*
******************************************************************************************************/

int main(void) {
  // check if app loader driver exists
  if (!libtock_app_loader_exists()) {
    printf("No App Loader driver!\n");
    return -1;
  }

  printf("[Log] Simple test app to load an app dynamically.\n");

  // set up the setup done callback
  int err1 = libtock_app_loader_setup_subscribe(app_setup_done_callback, NULL);
  if (err1 != 0) {
    printf("[Error] Failed to set setup done callback: %d\n", err1);
    return err1;
  }

  // set up the write done callback
  int err2 = libtock_app_loader_write_subscribe(app_write_done_callback, NULL);
  if (err2 != 0) {
    printf("[Error] Failed to set flash write done callback: %d\n", err2);
    return err2;
  }

  // set up the finalize done callback
  int err3 = libtock_app_loader_set_finalize_upcall(app_finalize_done_callback, NULL);
  if (err3 != 0) {
    printf("[Error] Failed to set finalize done callback: %d\n", err3);
    return err3;
  }

  // set up the load done callback
  int err4 = libtock_app_loader_set_load_upcall(app_load_done_callback, NULL);
  if (err4 != 0) {
    printf("[Error] Failed to set load done callback: %d\n", err4);
    return err4;
  }

  printf("[Log] Running Tock Welcomes DPL App.\n");

  while (1) {
    run_app_loader();
    return 0;
  }
}
